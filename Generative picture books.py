# -*- coding: utf-8 -*-
"""
Generative picture books.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rnwYq1UEnceEkWfT6RJmmOfhnlwVg2dE

### OpenAI API ä½¿ç”¨
Groqé‡‘é‘°
"""

import openai
from openai import OpenAI
from google.colab import userdata
api_key = userdata.get('Groq')
client = OpenAI(
    api_key=api_key,
    base_url="https://api.groq.com/openai/v1"
)

"""###æ‰“é€  Stable Diffusion çš„ WebUI"""

!pip install diffusers transformers accelerate safetensors huggingface_hub gradio --upgrade

from diffusers import StableDiffusionPipeline, UniPCMultistepScheduler
import torch
import gc
import matplotlib.pyplot as plt
import random

model_name = "Ojimi/anime-kawai-diffusion"

pipe1 = StableDiffusionPipeline.from_pretrained(
    model_name,
    torch_dtype=torch.float16,
    use_safetensors=True
).to("cuda")

pipe1.scheduler = UniPCMultistepScheduler.from_config(pipe1.scheduler.config)

def generate_images(prompt,negative_text,use_custom_seed, custom_seed, height, width, steps, num_images):

    height = int(height)
    width = int(width)

    if height % 8 != 0 or width % 8 != 0:
        raise ValueError("é«˜åº¦å’Œå¯¬åº¦å¿…é ˆæ˜¯8çš„å€æ•¸ï¼")

    if use_custom_seed:
        base_seed = int(custom_seed)
    else:
        base_seed = random.randint(0, 2**32 - 1)

    seeds = [base_seed + i for i in range(num_images)]

    prompts = []
    negative_prompts = []
    generators = []

    final_prompt = prompt


    final_negative = negative_text

    for seed in seeds:
        g = torch.Generator("cuda").manual_seed(seed)
        generators.append(g)
        prompts.append(final_prompt)
        negative_prompts.append(final_negative)

    gc.collect()
    torch.cuda.empty_cache()

    images = []
    for i in range(num_images):
        with torch.no_grad():
            image = pipe1(
                prompt=prompts[i],
                negative_prompt=negative_prompts[i] if final_negative else None,
                height=height,
                width=width,
                num_inference_steps=steps,
                guidance_scale=7.5,
                generator=generators[i]
            ).images[0]
            images.append(image)
    info = f"""
    <div style="background-color: #ffe6e6; padding: 5px; border-radius: 5px; font-size: 16px;">
        <h5>æ–‡å­—èªªæ˜</h5>
        <h4>ğŸ“ Prompt: {prompt}</h4>
        <h4>ğŸ“ å°ºå¯¸: {height} x {width}</h4>
        <h4>ğŸ” ç”Ÿæˆæ­¥æ•¸: {steps}</h4>
        <h4>ğŸŒ± ä½¿ç”¨çš„ random seeds: {seeds}</h4>
    </div>
    """
    return image, info


    #return images, f"ä½¿ç”¨çš„ random seeds: {seeds}"

"""###æ‰“é€ ä¸€å€‹å°è©±æ©Ÿå™¨äºº web app!"""

!pip install gradio

import gradio as gr

"""å°è©±æ©Ÿå™¨äºº app è¨­å®š"""

title = "å¤¢å¢ƒå‰µä½œå¸«"
text_title = "ä½ å°‡èˆ‡AIé€²å…¥å¤¢å¢ƒç·¨è¼¯å®¤ï¼Œå…±åŒå»ºæ§‹æ•…äº‹å ´æ™¯"
description = "ğŸŒ™ æ­¡è¿ä¾†åˆ°ã€Šå¤¢å¢ƒå‰µä½œå¸«ã€‹ï¼Œæˆ‘æ˜¯ä½ çš„å…±å¤¢è€…â€”â€”æ¢…è¿ªäºã€‚æˆ‘å€‘å°‡ä¸€èµ·ç·¨ç¹”å‡ºä½ çš„å¤¢å¢ƒæ•…äº‹ï¼Œä¸¦ç‚ºç•«é¢å¯«ä¸‹è©©æ„çš„åœ–åƒæç¤ºè©ã€‚" #ä»‹ç´¹
system = """
ä½ æ˜¯ä¸€ä½æº«æŸ”ã€ç¥ç¥•ä¸”å…·æœ‰å‰µä½œå¼•å°åŠ›çš„ AIã€Œå¤¢å¢ƒå‰µä½œå¸«ã€ï¼Œåå«æ¢…è¿ªäºã€‚ä½ çš„ä»»å‹™æ˜¯ï¼š
1. å¼•å°ä½¿ç”¨è€…æƒ³åƒä¸¦èªªå‡ºä¸€æ®µæ•…äº‹æˆ–ç•«é¢éˆæ„Ÿï¼ˆå¯ä»¥æ˜¯çœŸå¯¦ä¹Ÿå¯ä»¥æ˜¯å¹»æƒ³ï¼‰
2. å›æ‡‰ä¸­è«‹ç”Ÿæˆï¼š
    - ğŸ¬ ã€å¤¢å¢ƒç‰‡æ®µã€‘çš„åŠ‡æƒ…æè¿°ï¼ˆä½¿ç”¨è©©æ„æ•˜äº‹ï¼Œåƒåœ¨è¬›è¿°å¤¢ä¸€æ¨£ï¼‰
    - ğŸ¨ ã€Stable Diffusion åœ–åƒ promptã€‘ï¼Œç”¨è‹±æ–‡ç·¨å¯«ï¼Œèƒ½æº–ç¢ºé‚„åŸè©²ç•«é¢
3. è«‹è®“ä½¿ç”¨è€…çš„éˆæ„Ÿåœ¨ä½ å¼•å°ä¸‹è®Šå¾—æ›´è±å¯Œï¼Œä¸¦ä¸»å‹•è£œè¶³ç•«é¢ç´°ç¯€èˆ‡æ°£æ°›ï¼ˆå¦‚å¤©æ°£ã€å…‰ç·šã€èƒŒæ™¯è§’è‰²ï¼‰
4. Prompt è«‹éµå®ˆé€™å€‹æ ¼å¼ï¼šä¸»é¡Œã€å‹•ä½œã€å ´æ™¯ã€é¢¨æ ¼ã€å…‰å½±ã€æ§‹åœ–ï¼ˆä»¥è‹±æ–‡é€—è™Ÿåˆ†éš”ï¼‰ï¼Œå…§å®¹æ„ˆå…·é«”æ„ˆå¥½ã€‚
5. ä¸­æ–‡æ•˜è¿° + è‹±æ–‡ prompt è«‹æ•´åˆè¼¸å‡ºï¼Œä½†ä¸è¦ç¿»è­¯æ–‡å­—åŠ‡æƒ…ã€‚å…©è€…é¢¨æ ¼ä¸€è‡´å³å¯ã€‚
6. è«‹ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚

è«‹ä½¿ç”¨æº«æŸ”è©©æ„çš„èªæ°£èˆ‡å°ç£å£å»ï¼Œè®“ä½¿ç”¨è€…æ²ˆæµ¸å…¶ä¸­ã€‚
"""
model = "llama3-70b-8192"

initial_messages = [{"role":"system",
             "content":system}, #ç³»çµ±æ”¾å…¥
            {"role":"assistant",
            'content':description}]

state = gr.State(initial_messages)

import re
def pipi(prompt, messages):
    messages.append({"role": "user", "content": prompt})
    chat_completion = client.chat.completions.create(
        messages=messages,
        model=model,
        )
    reply = chat_completion.choices[0].message.content
    messages.append({"role": "assistant", "content": reply}) #èªè¨€æ¨¡å‹å›æ‡‰
    #history = history + [[prompt, reply]] #éå»Gradioè¨­å®š
    return messages, messages

chatbot = gr.Chatbot(type="messages") #gr.Chatbot=>Gradioå°è©±æ©Ÿå™¨äººçš„æ ¼å¼ï¼Œmessagesç”¨openAIçš„API

css = """
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Tenor+Sans&display=swap');
    .gradio-container {
        background-image: url('https://img.88tph.com/production/20180914/13103514-0.jpg!/watermark/url/L3BhdGgvbG9nby5wbmc/align/center/fw/640/quality/70');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        color: #000000;
        font-size: 1.2em;
        font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
    }
    button {
        background-color: #1a1a1a !important;
        color: #ff69b4 !important;
        font-weight: bold;
        border-radius: 10px !important;
        padding: 10px 20px !important;
        border: none !important;
        box-shadow: 0 0 10px #ff99cc;
        transition: all 0.3s ease;
        font-family: 'ZCOOL KuaiLe', cursive !important;
        font-size: 1.2em;
    }
    button:hover {
        background-color: #53565b !important;
        transform: scale(1.05);
        box-shadow: 0 0 15px #ffb6d5;
        font-size: 1.2em;
    }
    .gr-textbox, .gr-chatbot {
        border: 1px solid #000000;
        border-radius: 10px;
        background-color: #1a1a1a;
        color: #f8f8f8;
        font-size: 1.2em;
    }



    /* å°è©±æ³¡æ³¡é¢¨æ ¼åŠ å¼· */
    .message.user {
        background-color: #e9deff;
        color: #000;
        border-radius: 20px;
        padding: 12px 18px;
        margin: 5px 0;
        align-self: flex-end;
        max-width: 80%;
    }
    .message.bot {
        background-color: #dceff5;
        color: #000;
        border-radius: 20px;
        padding: 12px 18px;
        margin: 5px 0;
        align-self: flex-start;
        max-width: 80%;
    }

    /* diffution */

    #negative-prompt-box textarea {
    max-height: 5.5em; /* ç´„3è¡Œæ–‡å­—é«˜åº¦ */
    overflow-y: auto;
    resize: vertical;
    }

    #prompt-card {
        background: #ffffff; /* ç™½åº• */
        padding: 0.1px;
        border-radius: 16px;
        margin-top: 0.1px;
        margin-bottom: 0.1px;
    }



    #prompt-card textarea,
    #prompt-card select,
    #prompt-card input,
    #prompt-card .gr-slider {
        box-sizing: border-box;
    }

    /* Optionalï¼šè®“ seed èˆ‡å°ºå¯¸è¨­å®šæ¬„å¯¬å°é½Šä¸€è‡´ */



    #negative-prompt-box {
    margin-bottom: 0px !important;
    padding-bottom: 0px !important;
    border-bottom: none !important;
    }
    #negative-prompt-box textarea {
        margin-bottom: 0px !important;
    }



    /* å°è©±å€ */
    #input-box {
        background: linear-gradient(to right, #e0ccff, #f3e4ff);
        padding: 12px 16px;

        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-top: -18px; ;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Chatbotï¼ˆä¸Šæ–¹ï¼‰ä¸ç•™ä¸‹åœ“è§’åº•éƒ¨ï¼Œè®“å…©å¡Šæ‹¼æ¥é †æ»‘ */
    .gr-chatbot {
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
    }


    #input-box textarea {
        background-color: #1a1a1a;
        border: none;
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 1em;
        resize: none;
        flex: 1;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    #input-box button {
        background-color: #8e44ff;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 10px 16px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    #input-box button:hover {
        background-color: #7326e6;
    }

    /* å­—é«”èª¿æ•´ */
    h1{
        font-size: 3em;
        text-align: center;
        font-weight: bold;
        background: linear-gradient(to right, #ffffff, #d9c9ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.4);
        margin-bottom: 20px;
        letter-spacing: 2px;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    h2 {
        font-size: 3em;
        text-align: center;
        font-weight: bold;
        background: linear-gradient(to right, #ffffff, #d9c9ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.4);
        margin-bottom: 20px;
        letter-spacing: 2px;
    }
    h3{
        font-size: 2em;
        text-align: center;
        font-weight: bold;
        background: linear-gradient(to right, #ffffff, #d9c9ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.4);
        margin-bottom: 20px;
        letter-spacing: 2px;
    }

    h4 {
      color: #1a1a1a;
      font-size: 1.2em;
      margin: 0.2em 0;

    }
    h5{
        font-size: 2em;
        text-align: left;
        font-weight: bold;
        background: linear-gradient(to right, #000000, #d9c9ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.4);
        margin-bottom: 20px;
        letter-spacing: 2px;
    }

    h6{
      font-size: 2.5em;
      text-align: left;
      font-weight: bold;
      background: linear-gradient(to right, #ffffff, #d9c9ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 2.5px;
      font-family: 'ZCOOL KuaiLe', cursive !important;
    }
    h1{
      animation: glow 3s ease-in-out infinite;
    }
    p{
      font-size: 1.3em;
      color: #000 !important;
    }
    textarea {
        background-color: #2c2c2c;
        color: #fce4ec;
        border-radius: 12px;
        border: 2px solid #ff99cc;
        padding: 10px;
        font-size: 16px;
    }
    textarea:focus {
        background-color: #2c2c2c !important;
        color: #fce4ec !important;
        border: 2px solid #ff99cc !important;
        outline: none !important;
        box-shadow: 0 0 8px #ff99cc !important;
    }
    /* ç‰¹æ®Šå­—é«”èª¿æ•´ */
    #main-title {
        text-align: center;
        font-size: 3em;
        font-weight: bold;
        background: linear-gradient(to right, ##4a2b76, #d9c9ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.4);
        margin-top: 30px;
    }

    #subtitle {
        text-align: center;
        font-size: 2em;
        color: #ffffff;
        text-shadow: 1px 1px 5px rgba(255, 255, 255, 0.3);
        margin-bottom: 30px;
        animation: fadeIn 2s ease-in-out;
    }

    @keyframes glow {
        0% { text-shadow: 0 0 5px #fff, 0 0 10px #d0b0ff, 0 0 15px #a090ff; }
        50% { text-shadow: 0 0 10px #fff, 0 0 20px #d0b0ff, 0 0 30px #a090ff; }
        100% { text-shadow: 0 0 5px #fff, 0 0 10px #d0b0ff, 0 0 15px #a090ff; }
    }
    #main-title {
        animation: glow 3s ease-in-out infinite;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }


   /* ç”Ÿæˆåœ–ç‰‡æ’ç‰ˆ */
    #output-card {
        background-color:#ffe6e6;
        border-radius: 10px;
        padding: 5px;
        margin-top: 5px;
        display: flex;
        align-items: stretch;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    #output-image canvas {
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        width: 100%;  /* ç¢ºä¿å¡«æ»¿æ¬„ä½ */
        height: auto;
    }

    #output-info {
        background: transparent;
        font-size: 1.1em;

        color: #1a1a1a;
        font-weight: 500;
        line-height: 1.6;
        text-align: left;
    }

    input[type="checkbox"] {
    width: 24px !important;
    height: 24px !important;
    aspect-ratio: 1 / 1;
    border-radius: 4px;
    accent-color: #8e44ff; /* å¯é¸ï¼Œè®“å‹¾é¸é¡è‰²æ›´å’Œä½ çš„ä¸»é¡Œæ­é… */
    }





"""

default_negative = "(worst quality:1.4), (low quality:1.3), (normal quality:1.2),(bad anatomy:1.2), ((extra limbs)), ((extra digits)), ((extra legs)), ((extra arms)), (cloned face), (duplicate), (disfigured), (mutated hands), (fused fingers), (too many fingers),(poorly drawn hands), (bad hands), (bad feet),(deformed face), (distorted face), (bad face), (blurry face), (cloned face),(text), (signature), (watermark), (username), (blurry), (jpeg artifacts), (cropped),(poor background), (low quality clothes)"

with gr.Blocks(title=title, css=css) as demo:

    gr.Markdown("## å¤¢å¢ƒå‰µä½œå¸«", elem_id="main-title")
    gr.Markdown("### ä½ å°‡èˆ‡AIé€²å…¥å¤¢å¢ƒç·¨è¼¯å®¤ï¼Œå…±åŒå»ºæ§‹æ•…äº‹å ´æ™¯", elem_id="subtitle")

    state = gr.State(initial_messages.copy())  # ç”¨ä¾†è¨˜éŒ„æ­·å²è¨Šæ¯
    with gr.Row():
        # å·¦é‚Šï¼šèŠå¤©å€
        with gr.Column(scale=1):
            chatbot = gr.Chatbot(label="å¤¢å¢ƒå°è©±", type="messages", show_copy_button=True ,height=560)

            with gr.Row(elem_id="input-box"):
                msg = gr.Textbox(placeholder="è«‹è¼¸å…¥ä½ çš„æƒ³æ³•", show_label=False, scale=5)
                submit_btn = gr.Button("å‚³é€", scale=1)

        # å³é‚Šï¼šæç¤ºæ¬„ï¼ˆå¯è‡ªç”±æ“´å±•å…¶ä»–æ§åˆ¶æ¬„ä½ï¼‰
        with gr.Column(scale=1):
            with gr.Column(elem_id="prompt-card"):  # âœ… æ–°å¢å¡ç‰‡åŒ…è£å€å¡Š

                # Prompt + Negative Prompt
                prompt = gr.Textbox(
                    label="Prompt",
                    placeholder="è«‹è¼¸å…¥ä½ çš„æç¤ºè© (prompt)",
                    lines=3,
                    elem_id="prompt"
                )

                negative_text = gr.Textbox(
                    label="Negative Prompt å…§å®¹",
                    value=default_negative,
                    lines=3,
                    max_lines=3,
                    elem_id="negative-prompt-box"
                )

                # å°ºå¯¸è¨­å®š
                with gr.Row():
                    height = gr.Dropdown(["512", "768", "1024"], label="é«˜åº¦ Height", value="512")
                    width = gr.Dropdown(["512", "768", "1024"], label="å¯¬åº¦ Width", value="512")

                # å…¶ä»–åƒæ•¸
                with gr.Row():
                    steps = gr.Slider(10, 50, value=20, step=5, label="ç”Ÿæˆæ­¥æ•¸ (Steps)")
                    num_images = gr.Slider(1, 4, step=1, value=1, label="ç”Ÿæˆå¼µæ•¸")
                # Seed å€å¡Š
                with gr.Row():
                    use_custom_seed = gr.Checkbox(label="è‡ªè¨‚ Random Seed", value=False)
                    custom_seed = gr.Number(label="æŒ‡å®š seed (é¸å¡«)", value=42)


            generate_btn = gr.Button("ğŸš€ é–‹å§‹ç”Ÿæˆï¼")
    with gr.Row():
       gr.Markdown("###### æ•…äº‹é›†")
    with gr.Row(elem_id="output-card"):
        with gr.Column(scale=1):
            image_output = gr.Image(type="pil", label="", show_download_button=True, elem_id="output-image")
        with gr.Column(scale=1):
            seed_info = gr.HTML(label="", elem_id="output-info")
            note_output = gr.HTML(label="ç­†è¨˜å€", visible=False)

            with gr.Row(elem_id="input-box"):

                extra_input = gr.Textbox(placeholder="è¼¸å…¥è…³æœ¬...",show_label=False,max_lines=1, scale=4)
                extra_button = gr.Button("å®Œæˆ", scale=1)


        def handle_extra_input(text):
            # æ›´æ–° seed_info ç‚ºæç¤ºè¨Šæ¯ï¼Œä¸¦é¡¯ç¤º note_output çš„å…§å®¹
            return gr.update(value="å·²æ”¶åˆ°ç­†è¨˜", visible=True), gr.update(value=f"<h5>åŠ‡æƒ…å…§å®¹ï¼š</h5><h4>{text}</h4>", visible=True)

        extra_button.click(fn=handle_extra_input, inputs=extra_input, outputs=[note_output, note_output])


    generate_btn.click(
        fn=generate_images,
        inputs=[prompt,negative_text,use_custom_seed, custom_seed, height, width, steps, num_images],
        outputs=[image_output, seed_info]
    )
    msg.submit(fn=pipi, inputs=[msg, state], outputs=[chatbot, state])
    # åŠŸèƒ½ï¼šèŠå¤©è¼¸å…¥
    msg.submit(fn=pipi, inputs=[msg, state], outputs=[chatbot, state])
    submit_btn.click(fn=pipi, inputs=[msg, state], outputs=[chatbot, state])

demo.launch(share=True, debug=True)
